{% extends "layouts/reader.njk" %}

{% block reader %}
  <div class="compose">
    <a href="{{ backUrl or (baseUrl + '/channels') }}" class="back-link">
      {{ icon("previous") }} {{ __("Back") }}
    </a>

    <h2>{{ __("microsub.compose.title") }}</h2>

    {% if replyTo or reply %}
    <div class="compose__context">
      {{ icon("reply") }} {{ __("microsub.compose.replyTo") }}:
      <a href="{{ replyTo or reply }}" target="_blank" rel="noopener">
        {{ (replyTo or reply) | replace("https://", "") | replace("http://", "") }}
      </a>
    </div>
    {% endif %}

    {% if likeOf or like %}
    <div class="compose__context">
      {{ icon("like") }} {{ __("microsub.compose.likeOf") }}:
      <a href="{{ likeOf or like }}" target="_blank" rel="noopener">
        {{ (likeOf or like) | replace("https://", "") | replace("http://", "") }}
      </a>
    </div>
    {% endif %}

    {% if repostOf or repost %}
    <div class="compose__context">
      {{ icon("repost") }} {{ __("microsub.compose.repostOf") }}:
      <a href="{{ repostOf or repost }}" target="_blank" rel="noopener">
        {{ (repostOf or repost) | replace("https://", "") | replace("http://", "") }}
      </a>
    </div>
    {% endif %}

    {% if bookmarkOf or bookmark %}
    <div class="compose__context">
      {{ icon("bookmark") }} {{ __("microsub.compose.bookmarkOf") }}:
      <a href="{{ bookmarkOf or bookmark }}" target="_blank" rel="noopener">
        {{ (bookmarkOf or bookmark) | replace("https://", "") | replace("http://", "") }}
      </a>
    </div>
    {% endif %}

    <form method="post" action="{{ baseUrl }}/compose">
      {% if replyTo or reply %}
      <input type="hidden" name="in-reply-to" value="{{ replyTo or reply }}">
      {% endif %}
      {% if likeOf or like %}
      <input type="hidden" name="like-of" value="{{ likeOf or like }}">
      {% endif %}
      {% if repostOf or repost %}
      <input type="hidden" name="repost-of" value="{{ repostOf or repost }}">
      {% endif %}
      {% if bookmarkOf or bookmark %}
      <input type="hidden" name="bookmark-of" value="{{ bookmarkOf or bookmark }}">
      {% endif %}

      {% set isAction = (likeOf or like) or (repostOf or repost) or (bookmarkOf or bookmark) %}

      {% if not isAction %}
      {{ textarea({
        label: __("microsub.compose.content"),
        id: "content",
        name: "content",
        rows: 5,
        attributes: { autofocus: true }
      }) }}
      <div class="compose__counter">
        <span id="char-count">0</span> characters
      </div>
      {% endif %}

      <div class="button-group">
        {{ button({
          text: __("microsub.compose.submit")
        }) }}
        <a href="{{ backUrl or (baseUrl + '/channels') }}" class="button button--secondary">
          {{ __("microsub.compose.cancel") }}
        </a>
      </div>
    </form>
  </div>

  {% if not isAction %}
  <script type="module">
    const textarea = document.getElementById('content');
    const counter = document.getElementById('char-count');
    if (textarea && counter) {
      textarea.addEventListener('input', () => {
        counter.textContent = textarea.value.length;
      });
    }
  </script>
  {% endif %}
{% endblock %}
